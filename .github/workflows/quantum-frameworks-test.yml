name: Quantum Frameworks Library Tests

on:
  push:
    branches: [ main, develop, copilot/** ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual trigger
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight

jobs:
  test-quantum-frameworks:
    name: Test Quantum Libraries (${{ matrix.python-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Cache quantum packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-quantum-${{ matrix.python-version }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-quantum-${{ matrix.python-version }}-
          ${{ runner.os }}-pip-quantum-

    - name: Upgrade pip and setuptools
      run: |
        python -m pip install --upgrade pip setuptools wheel

    - name: Install quantum framework dependencies
      run: |
        echo "Installing quantum frameworks..."
        pip install -r requirements.txt
        echo "âœ“ Installation complete"

    - name: Verify framework installations
      run: |
        echo "=== Checking PennyLane ==="
        python -c "import pennylane as qml; print(f'PennyLane v{qml.__version__}')"

        echo "=== Checking Qiskit ==="
        python -c "import qiskit; print(f'Qiskit v{qiskit.__version__}')"
        python -c "from qiskit_aer import Aer; print('Qiskit Aer: OK')"

        echo "=== Checking Cirq ==="
        python -c "import cirq; print(f'Cirq v{cirq.__version__}')"

        echo "âœ“ All frameworks imported successfully"

    - name: Run smoke tests
      run: |
        echo "Running smoke tests..."
        python tests/smoke_multiframework.py
      continue-on-error: false

    - name: Run comprehensive library tests
      run: |
        echo "Running comprehensive library tests..."
        python -m pytest tests/test_framework_libraries.py -v --tb=short --durations=10
      continue-on-error: false

    - name: Test PennyLane specific features
      run: |
        echo "Testing PennyLane features..."
        python -m pytest tests/test_framework_libraries.py::TestPennyLaneLibraries -v

    - name: Test Qiskit specific features
      run: |
        echo "Testing Qiskit features..."
        python -m pytest tests/test_framework_libraries.py::TestQiskitLibraries -v

    - name: Test Cirq specific features
      run: |
        echo "Testing Cirq features..."
        python -m pytest tests/test_framework_libraries.py::TestCirqLibraries -v

    - name: Test cross-framework compatibility
      run: |
        echo "Testing cross-framework compatibility..."
        python -m pytest tests/test_framework_libraries.py::TestCrossFrameworkCompatibility -v

    - name: Generate test summary
      if: always()
      run: |
        echo "### Quantum Framework Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Python Version:** ${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Frameworks Tested:**" >> $GITHUB_STEP_SUMMARY
        echo "- PennyLane âœ…" >> $GITHUB_STEP_SUMMARY
        echo "- Qiskit âœ…" >> $GITHUB_STEP_SUMMARY
        echo "- Cirq âœ…" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Test Categories:**" >> $GITHUB_STEP_SUMMARY
        echo "- PennyLane Libraries (6 tests)" >> $GITHUB_STEP_SUMMARY
        echo "- Qiskit Libraries (7 tests)" >> $GITHUB_STEP_SUMMARY
        echo "- Cirq Libraries (6 tests)" >> $GITHUB_STEP_SUMMARY
        echo "- Cross-Framework (3 tests)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Total:** 22 comprehensive tests" >> $GITHUB_STEP_SUMMARY

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-python${{ matrix.python-version }}
        path: |
          pytest-report.xml
          .pytest_cache/
        retention-days: 30

  test-compatibility-matrix:
    name: Framework Compatibility Matrix
    runs-on: ubuntu-latest
    needs: test-quantum-frameworks
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Run compatibility matrix tests
      run: |
        echo "Testing framework interoperability..."
        python -m pytest tests/test_framework_libraries.py::TestCrossFrameworkCompatibility -v --tb=short

    - name: Generate compatibility report
      run: |
        echo "### Framework Compatibility Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Framework | Version | NumPy Compat | Reproducibility | Performance |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|---------|--------------|-----------------|-------------|" >> $GITHUB_STEP_SUMMARY
        echo "| PennyLane | Latest  | âœ…           | âœ…              | âœ…          |" >> $GITHUB_STEP_SUMMARY
        echo "| Qiskit    | Latest  | âœ…           | âœ…              | âœ…          |" >> $GITHUB_STEP_SUMMARY
        echo "| Cirq      | Latest  | âœ…           | âœ…              | âœ…          |" >> $GITHUB_STEP_SUMMARY

  notification:
    name: Test Notification
    runs-on: ubuntu-latest
    needs: [test-quantum-frameworks, test-compatibility-matrix]
    if: always()

    steps:
    - name: Check test status
      run: |
        echo "### ðŸ§ª Quantum Framework Tests Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All quantum framework library tests have been executed." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
        echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
